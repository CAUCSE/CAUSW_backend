static def loadEnvToSystemProps(Test testTask, String env = "test") {
    def envFile = testTask.project.rootProject.file(".env.${env}")
    if (!envFile.exists()) {
        testTask.project.logger.lifecycle("⚠️ .env.${env} not found")
        return
    }

    testTask.project.logger.lifecycle("🔧 Loading to systemProperties from .env.${env} for task ${testTask.name}")

    envFile.eachLine { line ->
        def trimmedLine = line.trim()
        if (!trimmedLine || trimmedLine.startsWith('#')) return

        def (key, value) = line.split('=', 2)
        if (key && value) {
            testTask.systemProperty key.trim(), value.trim()
        }
    }
}

return this.&loadEnvToSystemProps
